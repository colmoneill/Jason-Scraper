{% block title %}
    <h2>group exhibition form</h2>
{% endblock %}

{% block body %}
  {% from "helpers/_form.html" import render_field, render_datepicker, upload_field, bound_upload_field, render_uploadfield %}
  <form method="post" enctype="multipart/form-data" id="groupExhibitionForm">
      {{ form.csrf_token }}
      {{ render_field(form.exhibition_name) }}
      <div class="row">
          <div class="col-xs-5 col-sm-4">
              {{ render_datepicker(form.start) }}
          </div>
          <div class="col-xs-5 col-xs-offset-1 col-sm-4 col-sm-offset-2">
              {{ render_datepicker(form.end) }}
          </div>
      </div>
      <hr>
      <!--<label>Which gallery?</label>-->
      {{ render_field(form.location) }}
      <hr>
      <!--<label>Included artists?</label>-->
      {{ render_field(form.artists) }}
      <hr>
      <div class="extra-artist-container">
        {% for artist in extra_artists: %}
            <div class="row form-group">
                <div class="col-xs-8 col-sm-6">
                    <input type="text" name="extra_artists" value="{{ artist }}" class="form-control extra-artist-row-field" />
                </div>
                <div class="col-xs-4 col-sm-2">
                    <button type="button" class="btn btn-danger btn-sm extra-artist-row-remove">Remove</button>
                    <button type="button" class="btn btn-default btn-sm extra-artist-row-restore" style="display:none">Restore</button>
                </div>
            </div>
        {% endfor %}
      </div>
      <div class="row form-group">
        <div class="col-xs-8 col-sm-6">
            <input type="text" value="" class="form-control" id="extra-artist-input" />
        </div>
        <div class="col-xs-4 col-sm-2">
            <button type="button" class="btn btn-default" id="extra-artist-button">Add</button>
        </div>
      </div>
    <script type="text/javascript">
            window.addEventListener('load', function () {
                var sourceFieldQuery = '#extra-artist-input';
                var addButtonQuery = '#extra-artist-button';
                var templateQuery = '#extra-artist-row-template';
                var containerQuery = '.extra-artist-container';
                var fieldQuery = '.extra-artist-row-field';
                var removeQuery = '.extra-artist-row-remove';
                var restoreQuery = '.extra-artist-row-restore';
            
                var remove = function () {
                    $(this).parents('.row').find(fieldQuery).prop('disabled', true);
                    $(this).parents('.row').find(restoreQuery).show();
                    $(this).hide();
                };
            
                var restore = function () {
                    $(this).parents('.row').find(fieldQuery).removeProp('disabled');
                    $(this).parents('.row').find(removeQuery).show();
                    $(this).hide();
                };
            
                $(removeQuery).click(remove);
                $(restoreQuery).click(restore);
                
                $(addButtonQuery).click(function () {
                    var $sourceField = $(sourceFieldQuery);
                    var $el = $($(templateQuery).text());
                    
                    $el.find(restoreQuery).click(restore);
                    $el.find(removeQuery).click(remove);
                    $el.find(fieldQuery).val($sourceField.val());
                    $sourceField.val('');
                    
                    $(containerQuery).append($el);
                });
            }, false);
        </script>
        <script type="text/template" id="extra-artist-row-template">
            <div class="row form-group">
                <div class="col-xs-8 col-sm-6">
                    <input type="text" name="extra_artists" value="{{ artist }}"  class="form-control extra-artist-row-field" />
                </div>
                <div class="col-xs-4 col-sm-2">
                    <button type="button" class="btn btn-danger btn-sm extra-artist-row-remove">Remove</button>
                    <button type="button" class="btn btn-default btn-sm extra-artist-row-restore" style="display:none">Restore</button>
                </div>
            </div>
        </script>
      <hr>
      {{ upload_field('artworks', 'Select artworks in exhibition') }}
      <hr>
      {{ upload_field('coverimage', 'Cover Image', coverimage) }}
      <hr>
      {{ upload_field('image', 'Exhibition Views', images) }}
      <hr>
      <div class="row">
        <div class="col-xs-6">
          <label>Exhibition main text</label> <a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#headers">markdown enabled</a>
          {{ form.wysiwig_exhibition_description(only_input=True, rows=20) }}
        </div>
        <div class="col-xs-6">
          <label>&larr; Text preview</label>
          {{ form.wysiwig_exhibition_description(only_preview=True) }}
        </div>
      </div>
      <hr>
      {{ render_uploadfield(form.press_release) }}
      <hr>

      <div class="row">
        <div class="col-sm-12">
          <h4>media link 1</h4>
        </div>
          <div class="col-sm-6">
            {{ render_field(form.link_name1) }}
          </div>
          <div class="col-sm-6">
            {{ render_field(form.link_url1) }}
          </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-sm-12">
          <h4>media link 2</h4>
        </div>
          <div class="col-sm-6">
            {{ render_field(form.link_name2) }}
          </div>
          <div class="col-sm-6">
            {{ render_field(form.link_url2) }}
          </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-sm-12">
          <h4>media link 3</h4>
        </div>
          <div class="col-sm-6">
            {{ render_field(form.link_name3) }}
          </div>
          <div class="col-sm-6">
            {{ render_field(form.link_url3) }}
          </div>
      </div>
      <hr>
      <button type="submit" class="btn btn-default" id="submit-button">Submit</button>
      <button class="btn btn-default hide" disabled="disabled" id="processing-button"><span class="glyphicon glyphicon-refresh spin" aria-hidden="true"></span>&nbsp;Processing...</button>
  </form>
  <script type="text/javascript" src="/static/js/upload.js"></script>
    <script type="text/javascript">
        window.addEventListener("load", function () {
            var form = new Form($('form#groupExhibitionForm'));
            form.addUploadField("coverimage");
            form.addUploadField("image");
            var artworksField = form.addBoundUploadField("artworks");
            var thumbnails = {};
            var artworks = {};
            {% autoescape false %}
            var preselectedArtworks = JSON.parse('{{ selectedArtworks }}');
            {% endautoescape %}
            
            var preselectedArtworksSort = function (a, b) {
                var index_a = preselectedArtworks.indexOf(a.path),
                    index_b = preselectedArtworks.indexOf(b.path);
                    
                // a is selected
                if (index_a > -1) {
                    if (index_b > -1 && index_a > index_b) {
                        return 1;
                    }
                    
                    // a is selected, but b isn't, or b is bigger
                    return -1
                }
                // a is not selected, but b is
                else if (index_b > -1) {
                    return 1;
                }
                
                // Both unselected, equal
                return 0;
            };
            
            var reflowImages = function () {
                var images = [];
                
                for (id in artworks) {
                    if (!(id in thumbnails)) {
                        thumbnails[id] = [];
                    }
                    
                    for (var i=0;i<thumbnails[id].length;i++){
                        thumbnails[id][i].$el.detach();
                    }
                    
                    images = images.concat(artworks[id]);
                }
                
                images.sort(preselectedArtworksSort);
                for (var i=0; i<images.length;i++) {
                                        var thumb = artworksField.addThumbnail('/' + images[i].path);
                    thumb.$el.append('<input type="hidden" name="' + artworksField.name + '" value="' + images[i].path + '" />');
                    if (preselectedArtworks.indexOf(images[i].path) < 0) {
                        thumb.delete();
                    }
                    thumbnails[id].push(thumb);
                }
            };

            $('[name="artists"]').each(function () {
                $(this).change(function () {
                    var id = $(this).val();

                    if ($(this).prop('checked')) {
                        
                        
                        if (!(id in artworks)) {
                            artworks[id] = [];
                        }

                        jQuery.get(
                            '/admin/api/artist/' + id + '/image',
                            null,
                            function (images) {
                                artworks[id] = images;
                                reflowImages();
                            },
                            'json'
                        );
                    } else {
                        if (id in artworks) {
                            artworks[id] = [];
                        }
                        if (id in thumbnails) {
                            for (var i=0;i<thumbnails[id].length;i++){
                                thumbnails[id][i].$el.detach();
                            }
                        }
                        
                        reflowImages();
                    }
                });

                $(this).trigger('change');
            });
        }, false);
    </script>
  <script type="text/javascript">
      window.addEventListener('load', function () {
          /**
          * Bless the datepickers
          */
          (function ($) {
              'use strict';

              $('#datepicker-start').on('dp.change', function (e) {
                  $('#datepicker-end').data("DateTimePicker").minDate(e.date);
              });
          })($);
      }, false);
  </script>
{% endblock %}
