{% block title %}
    <h2>group exhibition form</h2>
{% endblock %}

{% block body %}
  {% from "helpers/_form.html" import render_field, render_datepicker, upload_field, bound_upload_field %}
  <form method="post" enctype="multipart/form-data" id="groupExhibitionForm">
      {{ form.csrf_token }}
      {{ render_field(form.exhibition_name) }}
      <div class="row">
          <div class="col-xs-5 col-sm-4">
              {{ render_datepicker(form.start) }}
          </div>
          <div class="col-xs-5 col-xs-offset-1 col-sm-4 col-sm-offset-2">
              {{ render_datepicker(form.end) }}
          </div>
      </div>
      <hr>
      <!--<label>Which gallery?</label>-->
      {{ render_field(form.location) }}
      <hr>
      <!--<label>Included artists?</label>-->
      {{ render_field(form.artists) }}
      <hr>
      <div class="row">
        <div class="col-md-12 clearfix">
          {{ render_field(form.extra_artists) }}
        </div>
      </div>
      <hr>
      {{ upload_field('artworks', 'Select artworks in exhibition') }}
      <hr>
      {{ upload_field('coverimage', 'Cover Image', coverimage) }}
      <hr>
      {{ upload_field('image', 'Exhibition Views', images) }}
      <hr>
      <div class="row">
        <div class="col-xs-6">
          <label>Exhibition main text</label> <a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#headers">markdown enabled</a>
          {{ form.wysiwig_exhibition_description(only_input=True, rows=20) }}
        </div>
        <div class="col-xs-6">
          <label>&larr; Text preview</label>
          {{ form.wysiwig_exhibition_description(only_preview=True) }}
        </div>
      </div>
      <hr>
      <label>press release file</label>
      {{ form.press_release_file }}
      <hr>

      <div class="row">
        <div class="col-sm-12">
          <h4>media link 1</h4>
        </div>
          <div class="col-sm-6">
            {{ render_field(form.link_name1) }}
          </div>
          <div class="col-sm-6">
            {{ render_field(form.link_url1) }}
          </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-sm-12">
          <h4>media link 2</h4>
        </div>
          <div class="col-sm-6">
            {{ render_field(form.link_name2) }}
          </div>
          <div class="col-sm-6">
            {{ render_field(form.link_url2) }}
          </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-sm-12">
          <h4>media link 3</h4>
        </div>
          <div class="col-sm-6">
            {{ render_field(form.link_name3) }}
          </div>
          <div class="col-sm-6">
            {{ render_field(form.link_url3) }}
          </div>
      </div>
      <hr>
      <button type="submit" class="btn btn-default" id="submit-button">Submit</button>
      <button class="btn btn-default hide" disabled="disabled" id="processing-button"><span class="glyphicon glyphicon-refresh spin" aria-hidden="true"></span>&nbsp;Processing...</button>
  </form>
  <script type="text/javascript" src="/static/js/upload.js"></script>
    <script type="text/javascript">
        window.addEventListener("load", function () {
            var form = new Form($('form#groupExhibitionForm'));
            form.addUploadField("coverimage");
            form.addUploadField("image");
            var artworksField = form.addBoundUploadField("artworks");
            var thumbnails = {};
            {% autoescape false %}
            var preselectedArtworks = JSON.parse('{{ selectedArtworks }}');
            {% endautoescape %}

            $('[name="artists"]').each(function () {
                $(this).change(function () {
                    var id = $(this).val();

                    if ($(this).prop('checked')) {
                        if (!(id in thumbnails)) {
                            thumbnails[id] = [];
                        }

                        jQuery.get(
                            '/admin/api/artist/' + id + '/image',
                            null,
                            function (images) {
                                for (var i=0; i<images.length;i++) {
                                    var thumb = artworksField.addThumbnail('/' + images[i].path);
                                    thumb.$el.append('<input type="hidden" name="' + artworksField.name + '" value="' + images[i]._id.$oid + '" />');
                                    if (preselectedArtworks.indexOf(images[i]._id.$oid) < 0) {
                                        thumb.delete();
                                    }
                                    thumbnails[id].push(thumb);
                                }
                            },
                            'json'
                        );
                    } else {
                        if (id in thumbnails) {
                            for (var i=0;i<thumbnails[id].length;i++){
                                thumbnails[id][i].$el.detach();
                            }
                        }
                    }
                });

                $(this).trigger('change');
            });
        }, false);
    </script>
  <script type="text/javascript">
      window.addEventListener('load', function () {
          /**
          * Bless the datepickers
          */
          (function ($) {
              'use strict';

              $('#datepicker-start').on('dp.change', function (e) {
                  $('#datepicker-end').data("DateTimePicker").minDate(e.date);
              });
          })($);
      }, false);
  </script>
{% endblock %}
